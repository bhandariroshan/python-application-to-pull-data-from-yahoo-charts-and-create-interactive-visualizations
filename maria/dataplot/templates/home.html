{% load staticfiles i18n %}
<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Maria Data Plot{% endblock title %}</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- <link rel="stylesheet" type="text/css" href="{% static 'css/fontawesomemin.css' %}"> -->
    
    <link rel="stylesheet" href="http://fontawesome.io/assets/font-awesome/css/font-awesome.css">    
    <link rel="stylesheet" href="http://davidstutz.github.io/bootstrap-multiselect/dist/css/bootstrap-multiselect.css">    

</head>

<body>

{% block navbar %}
    
{% endblock navbar %} 


{% block content %}
<div style="width:100%; height: 200px;">
    <div style="margin-top: 20px; height: 40px;">
        <div class="dropdown" style="float: right;">
            <select id="ddlTicker" style="float: right; margin-right: 10px;">
                {% for each_ticker in tickers %}
                    <option value="{{each_ticker}}">{{each_ticker}}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div style="margin-top: 10px; height: 30px;">
        <div class="col-sm-4"></div>
        <div id="search" style="" class="input-group col-sm-4">
          <div class="row">
              <div class="col-sm-10">
                  <input type="text" id="inpSearch" class="form-control" placeholder="Company Ticker" aria-describedby="basic-addon2">
              </div>
              <div class="col-sm-2">
                <button id="btnSearch" style="float:left" class="btn btn-primary btn-large">search</button>  
              </div>
          </div>
        </div>
        <div class="col-sm-4"></div>
    </div>

    <div style="margin-top: 10px;height: 50px;background: #c3c3c3;" class="row">
        <div class="col-sm-1" style="width:auto;">
            <div class="dropdown" style="margin:8px;">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-plus" aria-hidden="true"></i>
                <span style="margin-left:10px;">Add Indicator</span>
              </button>
              <ul class="dropdown-menu" style="width:400px; margin-left:10px;">
                <li id="simpleMoving" style="min-height:30px;">
                    <span style="margin-left:10px;">Simple Moving Average (SMA) </span>
                    <span>
                        <a href="#">
                            <i id="addSimpleMoving" class="fa fa-plus" aria-hidden="true" style="float:right; margin-right: 30px;"></i>
                        </a>
                    </span>
                </li>

                <li style="height:30px;">
                    <span style="margin-left:10px;">Exponential Moving Average (EMA) </span>
                    <span>
                        <a href="#">
                            <i class="fa fa-plus" aria-hidden="true" style="float:right; margin-right: 30px;"></i>
                        </a>
                    </span>
                    
                </li>

                <li style="height:30px;">
                    <span style="margin-left:10px;">Money Flow Index (MFI) </span>
                    <span>
                        <a href="#">
                            <i class="fa fa-plus" aria-hidden="true" style="float:right; margin-right: 30px;"></i>
                        </a>
                    </span>
                    
                </li>

                <li style="height:30px;">
                    <span style="margin-left:10px;">Moving Average Convergence Difference (MACD) </span>
                    <span>
                        <a href="#">
                            <i class="fa fa-plus" aria-hidden="true" style="float:right; margin-right: 30px;"></i>
                        </a>
                    </span>
                    
                </li>

                <li style="height:30px;">
                    <span style="margin-left:10px;">Relative Strength Index (RSI) </span>
                    <span>
                        <a href="#">
                            <i class="fa fa-plus" aria-hidden="true" style="float:right; margin-right: 30px;"></i>
                        </a>
                    </span>
                    
                </li>
                <li id="bollingerLi" style="min-height:30px;">
                    <span style="margin-left:10px;">Bollinger Band(BB) </span>
                    <span>
                        <a href="#">
                            <i id="addBollinger" class="fa fa-plus" aria-hidden="true" style="float:right; margin-right: 30px;"></i>
                        </a>
                    </span>
                    
                </li>
                <li style="height:30px;">
                    <span style="margin-left:10px;">Stochastic Oscilator </span>
                    <span>
                        <a href="#">
                            <i class="fa fa-plus" aria-hidden="true" style="float:right; margin-right: 30px;"></i>
                        </a>
                    </span>
                    
                </li>
              </ul>
            </div>
        </div>
        <div class="col-sm-1" style="margin-top:8px;">
            <!-- Build your select: -->
            <select  id="example-getting-started" multiple="multiple" style="max-height: 300px; overflow: overlay;">
                {% for each_ticker in tickers %}
                    <option value="{{each_ticker}}">{{each_ticker}}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-1" style="margin-left:30px;">
            <div class="dropdown" style="margin:8px;">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-sort-desc" aria-hidden="true"></i>
                <span id="timeSet" style="margin-left: 10px">1Y</span>
              </button>
              <ul class="dropdown-menu">
                    <li style="height: 20px; width: 300px;">
                        <div class="row" style="margin: 10px;">
                            <span class="col-sm-3">
                                <a onclick="get_data_and_plot('1m')" href="#" style="margin-left: 10px;">1m</a>
                            </span>
                            <span class="col-sm-3">
                                <a href="#" onclick="get_data_and_plot('3m')" style="margin-left: 10px;">3m</a>
                            </span>
                            <span class="col-sm-3">
                                <a onclick="get_data_and_plot('6m')" href="#" style="margin-left: 10px;">6m</a>
                            </span>
                            <span class="col-sm-3">
                                <a onclick="get_data_and_plot('1Y')" href="#" style="margin-left: 10px;">1Y</a>
                            </span>
                        </div>
                    </li>

                    <li style="height: 20px; width: 300px;">
                        <div class="row" style="margin: 10px;">
                            <span class="col-sm-3">
                                <a onclick="get_data_and_plot('2Y')" href="#" style="margin-left: 10px;">2Y</a>
                            </span>

                            <span class="col-sm-3">
                                <a onclick="get_data_and_plot('5Y')" href="#" style="margin-left: 10px;">5Y</a>
                            </span>
                            <span class="col-sm-3">
                                <a onclick="get_data_and_plot('10Y')" href="#" style="margin-left: 10px;">10Y</a>
                            </span>
                            <span class="col-sm-3">
                                <a onclick="get_data_and_plot('max')" href="#" style="margin-left: 10px;">Max</a>
                            </span>
                        </div>
                    </li>
              </ul>
            </div>
        </div>
        <div class="col-sm-1">
            <div class="dropdown" style="margin:8px;">
              <button id="resetBtn" class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-refresh" aria-hidden="true"></i>
                <span style="margin-left:10px;">Reset</span>
              </button>
            </div>
        </div>
    </div>
    <div id="container" style="min-width: 310px; height: 400px;border: 4px solid #d4d0d0;"></div>
</div>
{% endblock content %}

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script type="text/javascript" src="http://davidstutz.github.io/bootstrap-multiselect/dist/js/bootstrap-multiselect.js"></script>

{% block javascript %}
<script type="text/javascript">
var divCouter = 0;
var bollingerCount = 0;
selected_time = '1Y';
search_text = '';
prev = '';
my_tickers = [];

$('#inpSearch').on('change', function(){
    my_tickers = [$('#inpSearch').val()].concat($('#example-getting-started').val());
});

$('#resetBtn').on('click', function(){
    window.location.href = '/';
});

function remove_div(divCouter){
    $('#div'+ divCouter).remove();
}

$("#addBollinger").on('click', function(event){
    bollingerCount = bollingerCount + 1;
    my_html = '<div id="div' + bollingerCount + '" style="height: 40px"><div style="margin-left:20px;margin-top: 10px;">'
         /*+ '<span style="margin-left:10px; color: red;"><a href="#">S</a></span>'
         + '<span style="margin-left:10px; color: blue;"><a href="#">M</a></span>'
         + '<span style="margin-left:10px; color: green;"><a href="#">L</a></span>'*/
         + '<span style="float:right; margin-right: 20px;">Period: <input type="text" class="bollingerWindow" onChange="get_data_and_plot(\'' + selected_time.trim() + '\',' + "''" + "," + "'bollinger'" + ')" value="10" style="width:40px;"><a href="#"><i onclick="remove_div(' + bollingerCount + ')" class="fa fa-times" style="margin-left: 10px;" aria-hidden="true"></i></a></span>'
         + '</div></div>';
    $('#bollingerLi').append(my_html);
    event.stopPropagation();
    get_data_and_plot(selected_time, "", "bollinger");
});

$("#addSimpleMoving").on('click', function(event){
    divCouter = divCouter + 1;
    my_html = '<div id="div' + divCouter + '" style="height: 40px"><div style="margin-left:20px;margin-top: 10px;">'
         /*+ '<span style="margin-left:10px; color: red;"><a href="#">S</a></span>'
         + '<span style="margin-left:10px; color: blue;"><a href="#">M</a></span>'
         + '<span style="margin-left:10px; color: green;"><a href="#">L</a></span>'*/
         + '<span style="float:right; margin-right: 20px;">Period: <input type="text" class="smaWindow" onChange="get_data_and_plot(\'' + selected_time.trim() + '\',' + "''" + "," + "'sma'" + ')" value="10" style="width:40px;"><a href="#"><i onclick="remove_div(' + divCouter + ')" class="fa fa-times" style="margin-left: 10px;" aria-hidden="true"></i></a></span>'
         + '</div></div>';
    $('#simpleMoving').append(my_html);
    event.stopPropagation();
    get_data_and_plot(selected_time, "", "sma");
});



function draw_chart(data=[], labeldata=[]) {        
        var chart = new Highcharts.Chart({
        chart: {
            renderTo: 'container',
            /*zoomType: 'x'*/

        },
        tooltip: {
            formatter: function () {
                html = '';
                html += 'Close: <b>' + this.point.y + '</b><br/>';

                if(this.point.ticker){
                    html += 'Company: <b>' + this.point.ticker + '</b><br/>';
                }

                if (this.point.volume){
                    html += 'Volume: <b>' + this.point.volume + '</b><br/>';
                }

                return html;
            }
        },
        title: {
            text: 'Stock Trading data'
        },
        /*subtitle: {
            text: document.ontouchstart === undefined ?
                    'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
        },*/
        xAxis: {
            type: 'datetime'
        },
        yAxis: {
            title: {
                text: 'Trading Close Value'
            }
        },
        legend: {
            enabled: false
        },
        plotOptions: {
            series:{
                turboThreshold:5000//set it to a larger threshold, it is by default to 1000
            },
            area: {
                cropThreshold: 5,
                fillColor: {
                    linearGradient: {
                        x1: 0,
                        y1: 0,
                        x2: 0,
                        y2: 1
                    },
                    stops: [
                        [0, Highcharts.getOptions().colors[0]],
                        [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                    ]
                },
                marker: {
                    radius: 2
                },
                lineWidth: 1,
                states: {
                    hover: {
                        lineWidth: 1
                    }
                },
                threshold: null
            },
            line: {
                dataLabels: {
                    enabled: true
                }
            },
        }
    });

    chart.addSeries({
            type: 'area',
            name: labeldata[0],
            data: data[0]
        }, true);

        for (i=1; i<data.length; i++){
            chart.addSeries({
                    type: 'line',
                    name: labeldata[i],
                    zIndex: 1,
                    marker: {

                        lineWidth: 2,
                    },
                    data: data[i]
                },true);
        }

    }

    $('#btnSearch').on('click', function(){
        search_text = $('#inpSearch').val();
        get_data_and_plot(selected_time, search_text);
    });

returndata = [];

function get_compare(mytime='1Y', comp=[]){
        returndata = [];

        var url = '/chartdata/multiticker/';
        $('#timeSet').html(mytime);
        $.ajax({
          url: url,
          type: "get", //send it through get method
          data: { 
            'tickers': comp.toString(), 
            'time': mytime, 
          },
          success: function(mydata) {
            //Do Something
            console.log(comp);
            for (var i=0; i < comp.length; i++){
                var mykey = comp[i].toUpperCase();
                var data = mydata[mykey];
                /*
                for (var j=0; j < mydata[mykey].length; j++){
                    var my_date = mydata[mykey][j]['date'].split('-');
                    data.push({
                        x: Date.UTC(my_date[0], my_date[1]-1, my_date[2]),
                        y: parseFloat(mydata[mykey][j]['adj_close'].toFixed(2)),
                        volume: mydata[mykey][j]['volume'],
                        ticker: mydata[mykey][j]['ticker']

                    });
                }*/
                /*console.log(data);*/
                returndata.push(data);
            }
            draw_chart(returndata, comp);
          }
        });
}


function get_data_and_plot(mytime='1Y', searchtext="", urltype=""){
        if (searchtext==""){            
            if (search_text==""){
                search_text = $('#ddlTicker').val();
            }
        }
        selected_time = mytime;

        if(searchtext=="" && urltype == ""){
            get_compare(selected_time, my_tickers);
        }
        
        $('#timeSet').html(selected_time);
            
        var url = '/chartdata/' + search_text + '/' + mytime + '/';
        $.get(url, function(mydata) {
            var returndata = [];
            var data = [];
            var linedata = [];
            console.log(mydata);
            for (var i=0; i < mydata.length; i++){
                data.push({
                    x: mydata[i]['date'],
                    y: parseFloat(mydata[i]['adj_close'].toFixed(2)),
                    volume: parseFloat(mydata[i]['volume'].toFixed(2)),
                    ticker: mydata[i]['ticker']
                });

            }
            
            if(urltype!=""){
                // url('^chartdata/(?P<chart_type>.+)/(?P<ticker>.+)/(?P<time>.+)$',
                if(urltype=="bollinger"){
                    var window_period = $('.bollingerWindow')[0].value;
                }
                else if(urltype=="sma") {
                    var window_period = $('.smaWindow')[0].value;   
                }

                var url = '/chartdata/' + urltype + '/' + search_text + '/' + mytime + '/' + window_period;

                $.get(url, function(newdata) {
                  if(urltype=="bollinger"){
                    var upper_data = [] = newdata['upper'];
                    var lower_data = [] = newdata['lower'];;

                    /*for (var j=0; j < newdata['upper'].length; j++){
                        
                        var new_date = newdata['lower'][j]['date'].split('-');
                        upper_data.push({
                            x: newdata['lower'][j]['date'],
                            y: parseFloat(newdata['upper'][j]['adj_close']),
                            ticker: newdata['upper'][j]['volume']
                        });
                    }

                    for (var j=0; j < newdata['lower'].length; j++){
                        var new_date = newdata['lower'][j]['date'].split('-');
                        lower_data.push({
                            x: newdata['lower'][j]['date'],
                            y: parseFloat(newdata['lower'][j]['adj_close']),
                            ticker: newdata['lower'][j]['volume']
                        });

                    }*/

                      returndata[0] = data;
                      returndata[1] = upper_data;
                      returndata[2] = lower_data;

                      draw_chart(returndata, [searchtext.toUpperCase(), "Bollinger Upper", "Bollinger Lower"]);
                  }

                  else if(urltype=="sma"){
                        linedata = newdata;
                      /*for (var j=0; j < newdata.length; j++){
                        var new_date = newdata[j]['date'].split('-');
                        linedata.push({
                            x: Date.UTC(new_date[0], new_date[1]-1, new_date[2]),
                            y: parseFloat(newdata[j]['adj_close'].toFixed(2))
                        });
                      }*/

                      returndata[0] = data;
                      returndata[1] = linedata;
                      returndata[2] = [];
                      draw_chart(returndata, [searchtext.toUpperCase(), "Moving Average", ""]);
                  }

                });
            }
            else{
                returndata[0] = data;
                returndata[1] = [];
                returndata[2] = [];
                draw_chart(returndata, [searchtext.toUpperCase(), "", ""]);
            }
        });
    }

$('#ddlTicker').on('change', function(){
    myticker = $('#ddlTicker').val().toLowerCase();
    var index = my_tickers.indexOf(prev.toLowerCase());
    if (index > -1) {
        my_tickers.splice(index, 1);
    }
    
    my_tickers.push(myticker.toLowerCase());
    prev = myticker;
    get_compare(selected_time, my_tickers);
});

$(document).ready(function(){
    my_tickers = [$('#ddlTicker').val().toLowerCase()];
    prev = $('#ddlTicker').val().toLowerCase();
    get_compare(selected_time, my_tickers);
});

$(document).ready(function() {

    $('#example-getting-started').multiselect({
        onChange: function(option, checked) {

            var index = my_tickers.indexOf(option[0].value.toLowerCase());
            if (index > -1 && checked == false) {
               my_tickers.splice(index, 1);
            }
            else if (index > -1 && checked == true) {

            }
            else{
                my_tickers.push(option[0].value.toLowerCase());
            }
        },
        onDropdownHide: function(event) {
            // alert('onDropdownHide!');
            // call api for data
            get_compare(selected_time, my_tickers);
        }
    });
});

</script>
{% endblock javascript %}

</body>

</html>